const socket=io({secure:!0}),client=feathers().configure(feathers.hooks()).configure(feathers.socketio(socket)).configure(feathers.authentication({cookie:"feathers-jwt"})),users=client.service("/users");function logout(){client.logout(),window.location.href="/login.html"}client.authenticate().then(response=>(console.info("authenticated successfully"),client.set("jwt",response.accessToken),client.passport.verifyJWT(response.accessToken))).then(payload=>(console.info("verified JWT"),users.get(payload.userId))).then(user=>{"Student"===user.role?(client.set("user",user),reqNotificationPermission(),setNumTokens(),setAvailableTAs()):window.location.href="/"}).catch(error=>{console.log("auth error or not authenticated, redirecting...",error)}),toastr.options.closeDuration=1e4,toastr.options.positionClass="toast-bottom-right";var lastTotal=0,numTokens=-1,lastTicketCancelled=!1;function setNumTokens(){client.service("/numtokens").get().then(res=>(numTokens=res.tokensRemaining,$("#num-tokens").html("You have <strong>"+numTokens+"</strong> tokens remaining."),client.service("/tokens").find({query:{fulfilled:!1}}))).then(unfulfilledTokens=>{client.service("/queue-position").get().then(positionInfo=>{var shouldPushNotif=!1;unfulfilledTokens.total>0?(lastTotal=unfulfilledTokens.total,hideRequestOH(positionInfo.peopleAheadOfMe+1)):(0==unfulfilledTokens.total&&lastTotal>0&&!lastTicketCancelled&&(toastr.success("You have been dequeued by a TA!",{timeout:15e3}),shouldPushNotif=!0),lastTotal=unfulfilledTokens.total,lastTicketCancelled=!1,showRequestOH()),$("#students-in-queue").html(positionInfo.sizeOfQueue),getCurrentTicket(shouldPushNotif)}).catch(function(err){console.error(err)})})}function submitToken(){client.service("/tokens").create({desc:$("#ticket-desc").val(),passcode:$("#ticket-code").val()}).then(ticket=>{setNumTokens(),toastr.success("Your help request has been submitted!"),$("#ticket-desc").val("")}).catch(function(err){var errMsg="Your help request could not be submitted: ";errMsg+=numTokens<=0?"You are out of tokens.":err.message?err.message+".":"",toastr.error(errMsg)})}function setAvailableTAs(){client.service("/availabletas").find().then(setAvailableTAsHTML)}function cancelRequest(){client.service("/tokens").find({query:{fulfilled:!1}}).then(tickets=>{0==tickets.total?toastr.warning("There are no open tickets that can be canceled"):tickets.data.map(ticket=>{client.service("/tokens").patch(ticket._id,{fulfilled:!0,cancelledByStudent:!0}).then(ticket=>{lastTicketCancelled=!0,toastr.warning("Your help ticket has canceled"),setNumTokens()}).catch(function(err){toastr.error(err.message?err.message:"Cannot cancel ticket")})})})}var currentTicket=null;function getCurrentTicket(shouldPushNotif){client.service("/tokens").find({query:{$limit:1,fulfilled:!0,isBeingHelped:!0,$sort:{createdAt:1}}}).then(ticket=>{ticket.total>=1?(currentTicket=ticket.data[0],shouldPushNotif&&pushNotification(cfg.navbarTitle+": Dequeued","You have been dequeued by "+currentTicket.fulfilledByName),showCurrentTicket(currentTicket)):(currentTicket=null,$("#ticket-responder-name").html(""),$("#ticket-description").html(""),$("#current-ticket-area").hide())}).catch(function(err){console.error(err)})}function showCurrentTicket(ticket){$("#ticket-responder-name").html("TA "+ticket.fulfilledByName+" is assisting you"),$("#ticket-description").html(ticket.desc||"No description provided"),$("#current-ticket-area").show(),$("#ticket-submit-area").hide(),$("#ticket-no-submit").hide()}function setAvailableTAsHTML(availabletas){$("#num-tas").html(""+availabletas.total),$("#ta-table").find("tr").remove();var row=0,ttable=$("#ta-table")[0];0==availabletas.total&&(ttable.insertRow(row).insertCell(0).innerHTML='<small class="text-muted">No TAs are currently hosting office hours</small>'),availabletas.data.map(ta=>{ttable.insertRow(row).insertCell(0).innerHTML=ta.name||ta.directoryID,row++})}function hideRequestOH(numInQueue){$("#ticket-submit-area").hide(),$("#ticket-no-submit").show(),$("#ticket-queue-msg").html("You are #"+numInQueue+" in the queue")}function showRequestOH(){$("#ticket-submit-area").show(),$("#ticket-no-submit").hide(),$("#ticket-queue-msg").html("You are #0 in the queue")}socket.on("availabletas updated",setAvailableTAsHTML),socket.on("queue update",setNumTokens),$(function(){$("#ticket-submit-form").submit(function(e){e.preventDefault(),submitToken()}),$("#cancel-req").click(function(e){cancelRequest()})});
//# sourceMappingURL=student.js.map
